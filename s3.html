<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>martinbrochhaus.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="http://martinbrochhaus.com/theme/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/bootstrap-responsive.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github-numbers.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/styles.css" rel="stylesheet" media="screen">

    <link href='http://fonts.googleapis.com/css?family=Bitter:400,700' rel='stylesheet' type='text/css' >
    <link href='http://fonts.googleapis.com/css?family=Cantora+One' rel='stylesheet' type='text/css'>

        <link href="http://martinbrochhaus.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="martinbrochhaus.com Atom Feed" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1147761-33']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</head>
<body>
    <div class="miniBio">
        <div class="container">
            <a class="brand" href="/" title="martinbrochhaus.com"><img src="http://martinbrochhaus.com/theme/img/avatar.jpg" /></a>
            <span class="miniBioText">I build software with Python, Django, ReactJS & React-Native. Every day. All day long.</span>
        </div>
    </div>

    <div class="container">
<div class="container">
    <div class="row">
        <div class="span12 articleDetailHeadline">
            <h1>Django-Storages and Amazon S3</h1>
            <h2>How to serve your media files via Amazon's Simple Storage Service</h2>
        </div>
    </div>
</div>

<div class="container">
    <div class="row articleDetail">
        <div class="span3 articleInfo light">
<p><i class="icon-calendar"></i>&nbsp;Fri 11 April 2014</p>
    <p class="articleTags">
        <i class="icon-tag"></i>&nbsp;tags:
            <a href="http://martinbrochhaus.com/tag/python.html">python</a>
            <a href="http://martinbrochhaus.com/tag/django.html">django</a>
            <a href="http://martinbrochhaus.com/tag/amazon.html">amazon</a>
    </p>
        </div>
        <div class="span6 articleDetailContent">
            <p>Yesterday I migrated the media files of
<a href="https://publishizer.com">Publishizer.com</a> to <a href="http://aws.amazon.com/s3/">Amazon's Simple Storage
Service</a>. This relatively simple task took me
almost five hours and was quite a frustrating experience, so I thought I better
write this down for later reference.</p>
<h2>1. Create a Group</h2>
<ul>
<li>Go to <a href="https://console.aws.amazon.com/">https://console.aws.amazon.com/</a> and login</li>
<li>From the list of services select <a href="https://console.aws.amazon.com/iam/home?#home">IAM</a></li>
<li>Click at <code>Groups</code> and then <code>Create New Group</code></li>
<li>I named my group <code>Webservers</code></li>
<li>At the second step <code>Permissions</code> I selected <code>Custom Policy</code></li>
<li>I named the policy <code>Webservers-S3</code> and provided the following code</li>
</ul>
<p>Webserver Group Policy:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-04-10&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;s3:*&quot;</span><span class="p">,</span>
        <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>This should allow the group to do anything with the S3 service.</p>
<h2>2. Create a User</h2>
<ul>
<li>Now that we have a group with generous permissions, click at <code>Users</code></li>
<li>Click at <code>Create New User</code>.</li>
<li>I named my user <code>Webserver</code></li>
<li>Make sure that <code>Generate an access key for each User</code> is checked</li>
<li>In the pop-up window click at the link <code>Show User Security Credentials</code></li>
<li>Note down the two keys, you will need them in your Django settings later</li>
<li>Click at the new user and then at <code>Add User to Groups</code> in the bottom pane</li>
<li>Select the <code>Webservers</code> group.</li>
</ul>
<h2>3. Create a Bucket</h2>
<ul>
<li>Go back to the <a href="https://console.aws.amazon.com/">Console</a></li>
<li>Select <a href="https://console.aws.amazon.com/s3/home?region=us-west-2#">S3</a></li>
<li>Click at <code>Create Bucket</code> - give it a name and a region</li>
<li>Click at your new bucket and then at <code>Properties</code> at the top right</li>
<li>Click at <code>Permissions</code> and at <code>Add more permissions</code></li>
<li>Select <code>Authenticated Users</code> and grant <code>List</code>, <code>Upload/Delete</code>, <code>View
  Permissions</code></li>
<li>Click at `Edit bucket policy'</li>
</ul>
<p>Bucket Policy:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2008-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;AllowPublicRead&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;AWS&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;arn:aws:s3:::bucketname/*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;arn:aws:s3:::bucketname&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Make sure you replace <code>bucketname</code> with your bucket name.</p>
<p>This should allow anyone to access the files if they have the URL. For
Publishizer this is necessary because we will soon allow people to embed
campaign widgets in their websites. If you want to make sure that your media
files can only be accessed from your own server, you can create a more
restrictive policy that requires a certain IP or the request referrer header
to be yourdomain.com.</p>
<h2>4. Test Your Bucket</h2>
<p>At this point in time you should be able to upload stuff into your bucket and
access it via a web browser. You can try to manually upload an image and then
access it via <code>https://bucketname.s3.amazonaws.com/filename.png</code>.</p>
<h2>5. Install Django-storages</h2>
<p>Although it seems to be quite dated, everyone still seems to use it, so I
decided to use <a href="http://django-storages.readthedocs.org/en/latest/">django-storages</a>.</p>
<p>Note that I am NOT using S3 for static files. This is because it is a pain in
the ass because it slows down deployments. I know that there are tricks where
you would only download file headers from Amazon in order to figure out if a
static file needs replacement and then you would store this information in a
cache but I have not managed to get this working. Our static files (js, css,
a few tiny images) would be cached by our user's browsers anyways, so serving
them ourselves would only slow down the user for a few milliseconds and only
during the first visit. That's OK with me. It's the media files
 (i.e. book covers) that are big and many so it makes sense to offload them to
Amazon's unlimited disc space.</p>
<ul>
<li>In your Django project add <code>django-storages</code> and <code>boto</code> to the
  <code>requirements.txt</code></li>
<li>Add <code>'storages'</code> to your <code>INSTALLED_APPS</code> setting.</li>
</ul>
<p>Now it gets a bit complicated.</p>
<p>First of all, create a <code>s3utils.py</code> file somewhere in your project:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;Custom S3 storage backends to store files in subfolders.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">storages.backends.s3boto</span> <span class="kn">import</span> <span class="n">S3BotoStorage</span>

<span class="n">MediaRootS3BotoStorage</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">S3BotoStorage</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s">&#39;media&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>I do this because I might want to have several subfolders in my bucket in
the future (i.e. one for media files, one for static files, one for something
completely different that does not come from Django). For now I will only
have one folder for media files.</p>
<p>Here is what I have added to my
<code>local_settings.py</code> file:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">USE_S3</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">AWS_ACCESS_KEY</span> <span class="o">=</span> <span class="s">&#39;XXXX&#39;</span>
<span class="n">AWS_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s">&#39;XXXX&#39;</span>
<span class="n">AWS_STORAGE_BUCKET_NAME</span> <span class="o">=</span> <span class="s">&#39;bucketname-dev&#39;</span>
<span class="n">AWS_QUERYSTRING_AUTH</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">S3_URL</span> <span class="o">=</span> <span class="s">&#39;https://</span><span class="si">%s</span><span class="s">.s3.amazonaws.com&#39;</span> <span class="o">%</span> <span class="n">AWS_STORAGE_BUCKET_NAME</span>

<span class="k">if</span> <span class="n">USE_S3</span><span class="p">:</span>
    <span class="n">DEFAULT_FILE_STORAGE</span> <span class="o">=</span> <span class="s">&#39;myproject.s3utils.MediaRootS3BotoStorage&#39;</span>
    <span class="n">THUMBNAIL_DEFAULT_STORAGE</span> <span class="o">=</span> <span class="s">&#39;myproject.s3utils.MediaRootS3BotoStorage&#39;</span>
    <span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="n">S3_URL</span> <span class="o">+</span> <span class="s">&#39;/media/&#39;</span>

<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;../..&#39;</span><span class="p">,</span>  <span class="s">&#39;media&#39;</span><span class="p">)</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;../..&#39;</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<ul>
<li>This gives me the chance to turn off S3 when doing local development. If I
  really need to test something against S3, I can turn it on but use a another
  bucket for development work.</li>
<li>Locally I would use <code>bucketname-dev</code> but on the real server of course I would
  use the real <code>bucketname</code>. That means I have setup two identical buckets.</li>
<li><code>DEFAULT_FILE_STORAGE</code> is the setting that activates the magic. From now on
  all <code>FileFields</code> will upload their content to Amazon.</li>
<li>I'm using <code>easy_thumbnails</code> and the setting <code>THUMBNAIL_DEFAULT_STORAGE</code>
  makes sure that my thumbnails get uploaded to Amazon as well.</li>
<li>Usually I set <code>MEDIA_URL</code> to <code>/media/</code> in my normal django settings. When
  we activate S3, we must change that setting so that it is an absolute path
  to Amazon's S3 service.</li>
<li>You can leave <code>MEDIA_ROOT</code> and <code>STATIC_ROOT</code> as you would usually have it.
  When you switch off S3, everything will just continue to work like it did
  before.</li>
</ul>
<h2>6. Test Your Setup</h2>
<p>You should be able to run your local development server now and upload a file
via your app. It should end up in your Amazon S3 bucket. If it does not work,
you might need to create a file <code>$HOME/.boto</code> with the following content:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">[Credentials]</span>
<span class="na">aws_access_key_id</span> <span class="o">=</span> <span class="s">XXXX</span>
<span class="na">aws_secret_access_key</span> <span class="o">=</span> <span class="s">XXXX</span>
</pre></div>
</td></tr></table>

<p>I'm not sure though if this is really needed (after all you have those settings
in your Django settings already). I just remember that I ran into problems and
this got me one step further.</p>
<h2>7. Upload Your Current Media Files to S3</h2>
<p>If you upgraded a legacy app, you will now have the problem that all your
media files are still located on your webserver but you want them to be on
Amazon's cloud before you make the switch. Thankfully there is a tool similar
to <code>rsync</code> which syncs a local folder with a S3 folder.</p>
<ul>
<li>On your webserver download and unpack <a href="http://s3tools.org/download">s3cmd</a></li>
<li><code>cd</code> into the tool's folder and install the tool via <code>python setup.py install</code></li>
<li>Run <code>s3cmd --configure</code> and add your AWS access keys.</li>
</ul>
<p>Finally, this is how I uploaded all my existing media files to S3:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>s3cmd sync --delete-removed --skip-existing ~/webapps/media/* s3://bucketname/media/
</pre></div>
</td></tr></table>

<ul>
<li>The first parameter is the path to your media folder</li>
<li>The second parameter is your bucketname and the sub-folder that you want to
  use (if any)</li>
<li>Find out more about <a href="http://s3tools.org/s3cmd-sync">s3cmd sync</a></li>
</ul>
<h2>8. Refactor Where Necessary</h2>
<p>In our Django projects we usually have a setting:</p>
<ul>
<li>`FULL_DOMAIN = 'https://example.com'</li>
</ul>
<p>Then we add a context processor that adds this setting to all templates. This
is very helpful for email templates, because here you cannot rely on the
<code>{% static "img/test.png" %}</code> tag because it would generate a relative path.
When your customer opens the email in his email client, those relative paths
would, of course, be broken. Therefore we refer to static files in our email
templates like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ FULL_DOMAIN }}{% static &quot;</span><span class="na">img</span><span class="err">/</span><span class="na">test</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;</span> <span class="err">%}&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</td></tr></table>

<p>This will no longer be sufficient if you set <code>USE_S3 = True</code>. To work around
this I created a templatetag like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>

<span class="nd">@register.assignment_tag</span>
<span class="k">def</span> <span class="nf">get_full_domain</span><span class="p">(</span><span class="n">consider_s3</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">consider_s3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">USE_S3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DOMAIN</span>
</pre></div>
</td></tr></table>

<p>So basically if we are using S3, we don't return anything, if we are not using
S3, we return the <code>FULL_DOMAIN</code> setting.</p>
<p>My email template would now look like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>{% load project_tags %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{% get_full_domain %}{% static &quot;</span><span class="na">img</span><span class="err">/</span><span class="na">test</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;</span> <span class="err">%}&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</td></tr></table>

<p>By the way: I know that Django provides the Sites framwork for stuff like this
but we never use it and since we are always only creating single site Django
projects, having the site name in the Database is a maintenance nightmare. It
makes much more sense to us to set the sitename in the settings.</p>
<h2>9. Flip The Switch</h2>
<p>After this odyssey, you should be able to change the <code>local_settings.py</code> on
your production server like above and set <code>USE_S3 = True</code>. Then run your
deployment and visit your site.</p>
<p>Voila! Images are now served via Amazon! Now if this is not a good reason to
lean back and experience a good bottle of wine...</p>
<p><a href="https://publishizer.com/wine-sense/" target="_blank"><img src="https://publishizer.s3.amazonaws.com/media/thumbs/user_media/892/images/92fcb90f-df40-4bdc-86ed-a522ee3b376e.jpg.150x200_q85.jpg" /></a></p>
        </div>
    </div>
</div>

<div class="container">
    <div class="row comments">
        <div class="span3">&nbsp;</div>
        <div class="span6">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'martinbrochhauscom'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
</div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="span6">
                    <p><strong>Martin Brochhaus</strong> is the founder of <a href="http://bitmazk.com">Bitmazk Pte. Ltd.</a>. He is doing web development since 1998 and currently he is in love with Python & Django. Almost all of his work can be found on <a href="https://github.com/bitmazk">Github</a>. When he is not writing code, he gives <a href="https://speakerdeck.com/mbrochh">talks</a> or helps organizing <a href="https://pycon.sg">conferences</a>.</p>
                </div>
                <div class="span4">
                        <p><strong>Say hi!</strong></p>
                        <ul class="socialLinks">
                                <li><a href="https://github.com/mbrochh"><span class="symbol">&#xe037;</span> Github</a></li>
                                <li><a href="https://twitter.com/mbrochh"><span class="symbol">&#xe086;</span> Twitter</a></li>
                                <li><a href="https://secure.flickr.com/photos/mbrochh/"><span class="symbol">&#xe029;</span> Flickr</a></li>
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="http://martinbrochhaus.com/theme/js/bootstrap.min.js"></script>
</body>
</html>