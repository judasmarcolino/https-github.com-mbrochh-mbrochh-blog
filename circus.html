<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>martinbrochhaus.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="http://martinbrochhaus.com/theme/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/bootstrap-responsive.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github-numbers.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/styles.css" rel="stylesheet" media="screen">

    <link href='http://fonts.googleapis.com/css?family=Bitter:400,700' rel='stylesheet' type='text/css' >
    <link href='http://fonts.googleapis.com/css?family=Cantora+One' rel='stylesheet' type='text/css'>

        <link href="http://martinbrochhaus.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="martinbrochhaus.com Atom Feed" />
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1147761-33']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</head>
<body>
    <div class="miniBio">
        <div class="container">
            <a class="brand" href="/" title="martinbrochhaus.com"><img src="http://martinbrochhaus.com/theme/img/avatar.jpg" /></a>
            <span class="miniBioText">I build software with Python & Django. Every day. All day long.</span>
        </div>
    </div>

    <div class="container">
<div class="container">
    <div class="row">
        <div class="span12 articleDetailHeadline">
            <h1>Solr & Circus</h1>
            <h2>Daemonize Solr with Circus 0.5 on Webfaction</h2>
        </div>
    </div>
</div>

<div class="container">
    <div class="row articleDetail">
        <div class="span3 articleInfo light">
<p><i class="icon-calendar"></i>&nbsp;Fri 13 July 2012</p>
    <p class="articleTags">
        <i class="icon-tag"></i>&nbsp;tags:
            <a href="http://martinbrochhaus.com/tag/python.html">python</a>
            <a href="http://martinbrochhaus.com/tag/solr.html">solr</a>
            <a href="http://martinbrochhaus.com/tag/circus.html">circus</a>
    </p>
        </div>
        <div class="span6 articleDetailContent">
            <p>Since Webfaction increased the available memory from 40 MB to 250 MB I started
using Solr for more and more of my projects. However, I never really knew how
to ensure that Solr restarts itself if it crashes and how to easily stop and
start it in case I have to re-build the <code>schema.xml</code> file.</p>
<p>Then I found out about <a href="http://circus.readthedocs.org/en/0.5/index.html">Circus 0.5</a>
and got curious.</p>
<p>Here is what I did to install zeromq, solr and circus on a Webfaction server:</p>
<h2>Install zeromq</h2>
<p>Since we cannot install anything as root, I chose to install zeromq into
the folder <code>/opt/zeromq-2.2.0</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre>mkdir -p <span class="nv">$HOME</span>/src
mkdir -p <span class="nv">$HOME</span>/opt
mkdir -p <span class="nv">$HOME</span>/etc
<span class="nb">cd</span> <span class="nv">$HOME</span>/src
wget http://download.zeromq.org/zeromq-2.2.0.tar.gz
tar -xvf zeromq-2.2.0.tar.gz
<span class="nb">cd </span>zeromq-2.2.0
./configure --prefix<span class="o">=</span><span class="nv">$HOME</span>/opt/zeromq-2.2.0
make <span class="o">&amp;&amp;</span> make install
</pre></div>
</td></tr></table>

<h2>Install Circus</h2>
<p>Now we can install Circus. I assume that you are using virtualenv and
virtualenvwrapper:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>workon yourvenv
pip install circus
</pre></div>
</td></tr></table>

<p>This will fail because of the custom installation folder of zeromq. Thankfully
the failed zeromq build will remain in your virtualenv's build folder so that
you can install it again manually, this time giving it the path to your
zeromq installation:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">cd</span> /your/Venv/
<span class="nb">cd </span>build
<span class="nb">cd </span>pyzmq
python setup.py install --zmq<span class="o">=</span>/home/username/opt/zeromq-2.2.0
pip install circus
</pre></div>
</td></tr></table>

<h2>Install Solr</h2>
<p>Now let's install Solr, following <a href="http://django-haystack.readthedocs.org/en/latest/installing_search_engines.html#solr">this post</a>.
All you really need to do is download and unpack it:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$HOME</span>/opt
curl -O http://apache.mirrors.tds.net/lucene/solr/3.5.0/apache-solr-3.5.0.tgz
tar xvzf apache-solr-3.5.0.tgz
</pre></div>
</td></tr></table>

<h2>Configure Circus</h2>
<p>Create a <code>circus.ini</code> file somewhere on your file system. The following file
works great for me, just replace the path to your Solr installation
(usually just change your username):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">[</span>circus<span class="o">]</span>
<span class="nv">check_delay</span> <span class="o">=</span> 5
<span class="nv">endpoint</span> <span class="o">=</span> tcp://127.0.0.1:5555

<span class="o">[</span>watcher:solr<span class="o">]</span>
<span class="nv">cmd</span> <span class="o">=</span> java
<span class="nv">args</span> <span class="o">=</span> -Djava.util.logging.config.file<span class="o">=</span>logging.properties -jar start.jar
<span class="nv">working_dir</span> <span class="o">=</span> /home/&lt;USERNAME&gt;/opt/apache-solr-3.5.0/example
<span class="nv">warmup_delay</span> <span class="o">=</span> 0
<span class="nv">numprocesses</span> <span class="o">=</span> 1
<span class="nv">singleton</span> <span class="o">=</span> True
</pre></div>
</td></tr></table>

<p>Start circus:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>circusd circus.ini &amp;
</pre></div>
</td></tr></table>

<p>That's it. On my Webfaction server circus eats 15MB RAM. You can now start and
stop Solr using <code>circusctl</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>circusctl status solr
circusctl stop solr
circusctl start solr
</pre></div>
</td></tr></table>

<p>Or try to kill Solr. Circus will immediately restart it:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre>ps aux | grep java
<span class="nb">kill</span> &lt;solr PID&gt;
ps aux | grep java
</pre></div>
</td></tr></table>

<p>You need to be careful when starting and stopping Solr. Even though Circus will
return <code>[OK]</code> the process will remain visible for a few seconds after you
stopped it. Similarly it will not accept requests for a few seconds after it
has been started. So if you use start and stop in a shell script or Fabric
task better insert some <code>sleep</code> seconds before doing anything else with Solr.</p>
        </div>
    </div>
</div>

<div class="container">
    <div class="row comments">
        <div class="span3">&nbsp;</div>
        <div class="span6">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'martinbrochhauscom'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
</div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="span6">
                    <p><strong>Martin Brochhaus</strong> is the founder of <a href="http://bitmazk.com">Bitmazk Pte. Ltd.</a>. He is doing web development since 1998 and currently he is in love with Python & Django. Almost all of his work can be found on <a href="https://github.com/bitmazk">Github</a>. When he is not writing code, he gives <a href="https://speakerdeck.com/mbrochh">talks</a> or helps organizing <a href="https://pycon.sg">conferences</a>.</p>
                </div>
                <div class="span4">
                        <p><strong>Say hi!</strong></p>
                        <ul class="socialLinks">
                                <li><a href="https://github.com/mbrochh"><span class="symbol">&#xe037;</span> Github</a></li>
                                <li><a href="https://twitter.com/mbrochh"><span class="symbol">&#xe086;</span> Twitter</a></li>
                                <li><a href="https://secure.flickr.com/photos/mbrochh/"><span class="symbol">&#xe029;</span> Flickr</a></li>
                        </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="http://martinbrochhaus.com/theme/js/bootstrap.min.js"></script>
</body>
</html>