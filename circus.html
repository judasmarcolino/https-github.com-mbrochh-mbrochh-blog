<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="/theme/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="/theme/css/bootstrap-responsive.css" rel="stylesheet" media="screen">
    <link href="/theme/css/styles.css" rel="stylesheet" media="screen">

    <link href='http://fonts.googleapis.com/css?family=Bitter:400,700' rel='stylesheet' type='text/css' >
    <link href='http://fonts.googleapis.com/css?family=Cantora+One' rel='stylesheet' type='text/css'>
</head>
<body>
    <div class="miniBio">
        <div class="container">
            <a class="brand" href="./index.html" title="martinbrochhaus.com"><img src="/theme/img/avatar.jpg" /></a>
            <span class="miniBioText">I build software with Python & Django. Every day. All day long.</span>
        </div>
    </div>

    <div class="container">
        <div class="container">
    <div class="row">
        <div class="span12 articleDetailHeadline">
            <h1>Solr & Circus</h1>
            <h2>Daemonize Solr with Circus 0.5 on Webfaction</h2>
        </div>
    </div>
</div>

<div class="container">
    <div class="row articleDetail">
        <div class="span3 articleInfo light">
            <p><i class="icon-calendar"></i>&nbsp;Fri 13 July 2012</p>
    <p class="articleTags">
        <i class="icon-tag"></i>&nbsp;tags:
                    <a href="/tag/python.html">python</a>
                    <a href="/tag/solr.html">solr</a>
                    <a href="/tag/circus.html">circus</a>
            </p>
        </div>
        <div class="span6 articleDetailContent">
            <p>Since Webfaction increased the available memory from 40 MB to 250 MB I started
using Solr for more and more of my projects. However, I never really knew how
to ensure that Solr restarts itself if it crashes and how to easily stop and
start it in case I have to re-build the <code>schema.xml</code> file.</p>
<p>Then I found out about <a href="http://circus.readthedocs.org/en/0.5/index.html">Circus 0.5</a>
and got curious.</p>
<p>Here is what I did to install zeromq, solr and circus on a Webfaction server:</p>
<h2>Install zeromq</h2>
<p>Since we cannot install anything as root, I chose to install zeromq into
the folder <code>/opt/zeromq-2.2.0</code>:</p>
<div class="highlight"><pre><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> $<span class="n">HOME</span><span class="o">/</span><span class="n">src</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> $<span class="n">HOME</span><span class="o">/</span><span class="n">opt</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> $<span class="n">HOME</span><span class="o">/</span><span class="n">etc</span>
<span class="n">cd</span> $<span class="n">HOME</span><span class="o">/</span><span class="n">src</span>
<span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="p">.</span><span class="n">zeromq</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">zeromq</span><span class="o">-</span>2<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">tar</span> <span class="o">-</span><span class="n">xvf</span> <span class="n">zeromq</span><span class="o">-</span>2<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="n">cd</span> <span class="n">zeromq</span><span class="o">-</span>2<span class="p">.</span>2<span class="p">.</span>0
<span class="o">./</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="p">=</span>$<span class="n">HOME</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">zeromq</span><span class="o">-</span>2<span class="p">.</span>2<span class="p">.</span>0
<span class="n">make</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">install</span>
</pre></div>


<h2>Install Circus</h2>
<p>Now we can install Circus. I assume that you are using virtualenv and
virtualenvwrapper:</p>
<div class="highlight"><pre><span class="n">workon</span> <span class="n">yourvenv</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">circus</span>
</pre></div>


<p>This will fail because of the custom installation folder of zeromq. Thankfully
the failed zeromq build will remain in your virtualenv's build folder so that
you can install it again manually, this time giving it the path to your
zeromq installation:</p>
<div class="highlight"><pre><span class="n">cd</span> <span class="o">/</span><span class="n">your</span><span class="o">/</span><span class="n">Venv</span><span class="o">/</span>
<span class="n">cd</span> <span class="n">build</span>
<span class="n">cd</span> <span class="n">pyzmq</span>
<span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="n">py</span> <span class="n">install</span> <span class="o">--</span><span class="n">zmq</span><span class="p">=</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">username</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">zeromq</span><span class="o">-</span>2<span class="p">.</span>2<span class="p">.</span>0
<span class="n">pip</span> <span class="n">install</span> <span class="n">circus</span>
</pre></div>


<h2>Install Solr</h2>
<p>Now let's install Solr, following <a href="http://django-haystack.readthedocs.org/en/latest/installing_search_engines.html#solr">this post</a>.
All you really need to do is download and unpack it:</p>
<div class="highlight"><pre><span class="n">cd</span> $<span class="n">HOME</span><span class="o">/</span><span class="n">opt</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">O</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">apache</span><span class="p">.</span><span class="n">mirrors</span><span class="p">.</span><span class="n">tds</span><span class="p">.</span><span class="n">net</span><span class="o">/</span><span class="n">lucene</span><span class="o">/</span><span class="n">solr</span><span class="o">/</span>3<span class="p">.</span>5<span class="p">.</span>0<span class="o">/</span><span class="n">apache</span><span class="o">-</span><span class="n">solr</span><span class="o">-</span>3<span class="p">.</span>5<span class="p">.</span>0<span class="p">.</span><span class="n">tgz</span>
<span class="n">tar</span> <span class="n">xvzf</span> <span class="n">apache</span><span class="o">-</span><span class="n">solr</span><span class="o">-</span>3<span class="p">.</span>5<span class="p">.</span>0<span class="p">.</span><span class="n">tgz</span>
</pre></div>


<h2>Configure Circus</h2>
<p>Create a <code>circus.ini</code> file somewhere on your file system. The following file
works great for me, just replace the path to your Solr installation
(usually just change your username):</p>
<div class="highlight"><pre><span class="k">[circus]</span>
<span class="na">check_delay</span> <span class="o">=</span> <span class="s">5</span>
<span class="na">endpoint</span> <span class="o">=</span> <span class="s">tcp://127.0.0.1:5555</span>

<span class="k">[watcher:solr]</span>
<span class="na">cmd</span> <span class="o">=</span> <span class="s">java</span>
<span class="na">args</span> <span class="o">=</span> <span class="s">-Djava.util.logging.config.file=logging.properties -jar start.jar</span>
<span class="na">working_dir</span> <span class="o">=</span> <span class="s">/home/&lt;USERNAME&gt;/opt/apache-solr-3.5.0/example</span>
<span class="na">warmup_delay</span> <span class="o">=</span> <span class="s">0</span>
<span class="na">numprocesses</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">singleton</span> <span class="o">=</span> <span class="s">True</span>
</pre></div>


<p>Start circus:</p>
<div class="highlight"><pre><span class="n">circusd</span> <span class="n">circus</span><span class="p">.</span><span class="n">ini</span> <span class="o">&amp;</span>
</pre></div>


<p>That's it. On my Webfaction server circus eats 15MB RAM. You can now start and
stop Solr using <code>circusctl</code>:</p>
<div class="highlight"><pre><span class="n">circusctl</span> <span class="n">status</span> <span class="n">solr</span>
<span class="n">circusctl</span> <span class="n">stop</span> <span class="n">solr</span>
<span class="n">circusctl</span> <span class="n">start</span> <span class="n">solr</span>
</pre></div>


<p>Or try to kill Solr. Circus will immediately restart it:</p>
<div class="highlight"><pre><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">java</span>
<span class="n">kill</span> <span class="o">&lt;</span><span class="n">solr</span> <span class="n">PID</span><span class="o">&gt;</span>
<span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">java</span>
</pre></div>


<p>You need to be careful when starting and stopping Solr. Even though Circus will
return <code>[OK]</code> the process will remain visible for a few seconds after you
stopped it. Similarly it will not accept requests for a few seconds after it
has been started. So if you use start and stop in a shell script or Fabric
task better insert some <code>sleep</code> seconds before doing anything else with Solr.</p>
            <script type="text/javascript">
    var disqus_shortname = 'martinbrochhauscom';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
        </div>
    </div>
</div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="span6">
                    <p><strong>Martin Brochhaus</strong> is the founder of <a href="http://bitmazk.com">Bitmazk Pte. Ltd.</a>. He is doing web development since 1998 and currently he is in love with Python & Django. Almost all of his work can be found on <a href="https://github.com/bitmazk">Github</a>. When he is not writing code, he gives <a href="https://speakerdeck.com/mbrochh">talks</a> or helps organizing <a href="https://pycon.sg">conferences</a>.</p>
                </div>
                <div class="span4">
                                            <p><strong>Say hi!</strong></p>
                        <ul class="socialLinks">
                                                            <li><a href="https://github.com/mbrochh"><span class="symbol">&#xe037;</span> Github</a></li>
                                                            <li><a href="https://plus.google.com/101162916953876296847/about"><span class="symbol">&#xe039;</span> Google Plus</a></li>
                                                            <li><a href="https://twitter.com/mbrochh"><span class="symbol">&#xe086;</span> Twitter</a></li>
                                                            <li><a href="https://facebook.com/mbrochh"><span class="symbol">&#xe027;</span> Facebook</a></li>
                                                    </ul>
                                    </div>
            </div>
        </div>
    </div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>
        <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1147761-33']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>