<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="http://martinbrochhaus.com/theme/css/bootstrap.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/bootstrap-responsive.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/github-numbers.css" rel="stylesheet" media="screen">
    <link href="http://martinbrochhaus.com/theme/css/styles.css" rel="stylesheet" media="screen">

    <link href='http://fonts.googleapis.com/css?family=Bitter:400,700' rel='stylesheet' type='text/css' >
    <link href='http://fonts.googleapis.com/css?family=Cantora+One' rel='stylesheet' type='text/css'>
</head>
<body>
    <div class="miniBio">
        <div class="container">
            <a class="brand" href="./index.html" title="martinbrochhaus.com"><img src="http://martinbrochhaus.com/theme/img/avatar.jpg" /></a>
            <span class="miniBioText">I build software with Python & Django. Every day. All day long.</span>
        </div>
    </div>

    <div class="container">
        <div class="container">
    <div class="row">
        <div class="span12 articleDetailHeadline">
            <h1>Pair Programming With Tmux</h1>
            <h2>Secure pair programming with wemux and Vim</h2>
        </div>
    </div>
</div>

<div class="container">
    <div class="row articleDetail">
        <div class="span3 articleInfo light">
            <p><i class="icon-calendar"></i>&nbsp;Sat 26 May 2012</p>
    <p class="articleTags">
        <i class="icon-tag"></i>&nbsp;tags:
                    <a href="http://martinbrochhaus.com/tag/screen.html">screen</a>
                    <a href="http://martinbrochhaus.com/tag/tmux.html">tmux</a>
                    <a href="http://martinbrochhaus.com/tag/wemux.html">wemux</a>
                    <a href="http://martinbrochhaus.com/tag/vim.html">vim</a>
                    <a href="http://martinbrochhaus.com/tag/ssh.html">ssh</a>
                    <a href="http://martinbrochhaus.com/tag/programming.html">programming</a>
            </p>
        </div>
        <div class="span6 articleDetailContent">
            <p>At <a href="http://www.bitmazk.com">Bitmazk</a> we are a small team of web developers
with members located in Singapore and Germany. Of course we do codereviews
with Google's awesome <a href="https://code.google.com/p/rietveld/">Rietveld</a> but
often when someone has an immediate problem, pair programming is just so much
more efficient.</p>
<p>We used to use Skype for talking and Teamviewer for screen sharing, which
worked very well for a while but after recent updates both tools became so
unreliable that they started affecting our work. More importantly: Even when
those tools worked perfectly well there is significant lag between what I say
and what my coworker sees. It's just not an optimal solution for staring at a
terminal.</p>
<p>I first tried to set this up with GNU Screen and it almost worked but at the
final step I ran into a dead end. It seems as if
<a href="http://superuser.com/questions/117684/gnu-screen-multiuser-mode-is-broken-in-os-x-10-6-snow-leopard">multiuser support on OSX 10.7 is broken</a>.
Or maybe I was just too stupid to get the permissions for the guest user right. </p>
<p>As a last resort I tried to achieve my goal with
<a href="https://github.com/zolrath/wemux">wemux</a>. It worked right out of the box and
took me less than 5 minutes to setup. Goodbye GNU Screen, I guess.</p>
<p>The process I am going to describe here looks complex but it is really really
simple. Please don't give up here!</p>
<ol>
<li>Setup a new user <code>pairprogger</code></li>
<li>Authorize your colleagues to ssh into that user's account</li>
<li>Setup port forwarding in your router's settings</li>
<li>Enable remote login (OSX) / start an openssh-server (Ubuntnu)</li>
<li>Install tmux and wemux</li>
<li>Start a wemux server</li>
<li>Join a wemux server</li>
</ol>
<p>It will blow your mind even more if you had two machines at your disposal but
you will of course be able to test this with just one machine and two
terminals.</p>
<p>But rest assured that you won't be able to sleep until you find a real person
on the internet who you can show this little trick. You have been warned. ;)</p>
<h2>Step 1: Create a guest user account</h2>
<p>You will ask your colleagues to ssh into your machine for pair programming.
When I set this up I didn't bother about security at first as I just wanted
to see how this feels. I invited a very close friend of mine to test this
and I can tell you that it feels weird. You really don't want anyone in your
machine with access to your whole home folder. Especially not if he is a
hacker. At least I could come up with a dozen evil pranks immediately...</p>
<p>So let's create a new user called <code>pairprogger</code>. For OSX I have created a
file <code>create_user.sh</code>. Replace the three variables at the top and execute it.</p>
<p><strong>OSX</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># find out your staff group id (for me it is 20)</span>
<span class="c"># dscacheutil -q group</span>
<span class="nv">STAFF_GROUP_ID</span><span class="o">=</span>XX
<span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&quot;pairprogger&quot;</span>
<span class="nv">PASSWORD</span><span class="o">=</span><span class="s2">&quot;yourpassword&quot;</span>

<span class="nv">MAXID</span><span class="o">=</span><span class="k">$(</span>dscl . -list /Users UniqueID | awk <span class="s1">&#39;{print $2}&#39;</span> | sort -ug | tail -1<span class="k">)</span>
<span class="nv">NEWID</span><span class="o">=</span><span class="k">$((</span>MAXID+1<span class="k">))</span>

sudo dscl . -create /Users/<span class="nv">$USERNAME</span>
sudo dscl . -create /Users/<span class="nv">$USERNAME</span> UserShell /bin/bash
sudo dscl . -create /Users/<span class="nv">$USERNAME</span> UniqueID <span class="s2">&quot;$NEWID&quot;</span>
sudo dscl . -create /Users/<span class="nv">$USERNAME</span> PrimaryGroupID <span class="nv">$STAFF_GROUP_ID</span>
sudo dscl . -create /Users/<span class="nv">$USERNAME</span> RealName <span class="s2">&quot;Pair Programmer&quot;</span>
sudo dscl . -create /Users/<span class="nv">$USERNAME</span> NFSHomeDirectory /Users/<span class="nv">$USERNAME</span>
sudo dscl . -passwd /Users/<span class="nv">$USERNAME</span> <span class="nv">$PASSWORD</span>
sudo dscl . -append /Groups/com.apple.access_ssh GroupMembership <span class="nv">$USERNAME</span>
sudo createhomedir -c -u <span class="nv">$USERNAME</span>
<span class="c"># make sure that there is /Users/pairprogger/ on your disk now</span>
</pre></div>
</td></tr></table>

<p>I wont take credit for this insane user creation script for OSX.
This thread on serverfault about
<a href="http://serverfault.com/questions/20702/how-do-i-create-user-accounts-from-the-terminal-in-mac-os-x-10-5">how to create a user account on OSX</a>
certainly saved my ass.</p>
<p><strong>Ubuntu</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>sudo useradd -m -s /bin/bash pairprogger
sudo passwd pairprogger
</pre></div>
</td></tr></table>

<p>You should be able to test this by logging out. The new user should appear
on your login screen.</p>
<h2>Step 2: Restrict access via public RSA keys</h2>
<p>You know the password of <code>pairprogger</code> but you are not going to give it
away, as it cold get leaked and all kinds of people would be able to ssh into
your machine. Instead you will create a <code>.ssh</code> folder for the new user
and paste your colleagues public RSA keys into the <code>authorized_keys</code> file:</p>
<p><strong>OSX / Ubuntu</strong></p>
<div class="highlight"><pre><span class="n">su</span> <span class="o">-</span> <span class="n">pairprogger</span>
<span class="n">mkdir</span> <span class="p">.</span><span class="n">ssh</span>
<span class="n">chmod</span> <span class="mi">700</span> <span class="p">.</span><span class="n">ssh</span>
<span class="n">cd</span> <span class="p">.</span><span class="n">ssh</span>
<span class="n">touch</span> <span class="n">authorized_keys</span>
<span class="n">chmod</span> <span class="mi">600</span> <span class="n">authorized_keys</span>
</pre></div>


<p>Now copy the public RSA keys of the users you want to work with into the
<code>authorized_keys</code> file. You might want to add your own key as well in order
to test your setup later.</p>
<h2>Setp 3: Enable port forwarding</h2>
<p>There are certainly more elegant solutions where you tell your router that
this computer should <em>always</em> get that IP and where you setup dyndns and all
but I will describe a simpler approach here. Of course the drawback is that
your IP will change all the time and every day you might have to repeat these
steps.</p>
<p>Note down your <a href="https://duckduckgo.com/?q=ip">public IP</a></p>
<p>Note down your local IP:</p>
<p><strong>OSX</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>ipconfig getifaddr en1
</pre></div>
</td></tr></table>

<p><strong>Ubuntu</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>ifconfig wlan0 | grep <span class="s1">&#39;inet addr&#39;</span> | sed <span class="s1">&#39;s/.*inet addr:\([0-9.]*\).*/\1/&#39;</span>
</pre></div>
</td></tr></table>

<p>To setup port forwarding go to <code>192.168.0.1</code>. This IP might differ on your
router. Usually you should find a section for advanced settings which should
have a section for port forwarding or just forwarding. You should see a table
where you can enter your machine's local IP address and define which ports
should be forwarded. You should forward port 22 for SSH and 8000 for your
Django development server. The latter will enable you to do some pair
programming and then have a look at the result together, each worker in their
own browser.</p>
<h2>Step 4: Enable remote access</h2>
<p>Next you should start your local ssh server so that people can actually ssh
into your machine. If anyone knows how to do this on the command line in OSX,
please let me know in the comments! On Ubuntu I just had to install
<code>openssh-server</code> and it worked immediately. We will be extra paranoid here
and restrict access only to the <code>pairprogger</code> user and we will disallow
password authentication, which would allow people to crack your password
via bruteforce.</p>
<p><strong>OSX</strong></p>
<p>Go to <code>System Preferences</code> --&gt; <code>Sharing</code> --&gt; <code>Remote login</code>. Add
<code>Pair Programmer</code> to the list <code>Allow access for</code>.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre>sudo vim /etc/sshd_config
<span class="c"># Set PasswordAuthentication to no</span>
<span class="c"># Set ChallengeResponseAuthentication to no</span>
<span class="c"># Set UsePAM to no</span>
</pre></div>
</td></tr></table>

<p><strong>Ubuntu</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre>sudo apt-get install openssh-server
sudo vim /etc/ssh/sshd_config
<span class="c"># Set PasswordAuthentication to no</span>
<span class="c"># Add the following to the bottom of the file:</span>
<span class="c"># AllowUsers pairprogger</span>
</pre></div>
</td></tr></table>

<p>Please note that I am not a security expert. I have added these ssh
restrictions while writing this post and have not tested them thoroughly. It
would probably be a good idea to also make sure that the user <code>pairprogger</code>
is not allowed to leave his home folder and give him some quota so that he
cannot flood your hard drive with porn. If anyone knows useful settings to
further restrict this account, please leave them in the comments.</p>
<p>So this was the hard part. Now to the fun part...</p>
<h2>Step 5: Install tmux and wemux</h2>
<p>Since wemux seems to be based on tmux, you need to install both, but that
should be a no-brainer:</p>
<p><strong>OSX</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>brew install wemux
brew install https://github.com/downloads/zolrath/wemux/wemux.rb
</pre></div>
</td></tr></table>

<p><strong>Ubuntu</strong></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>sudo apt-get install tmux
</pre></div>
</td></tr></table>

<p>On Ubuntu follow the instructions at https://github.com/zolrath/wemux for
manual installation.</p>
<h2>Step 6: Start the wemux server</h2>
<p>You are ready to go. Type the following command:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre>wemux start
</pre></div>
</td></tr></table>

<h2>Step 7: Join the wemux server</h2>
<p>Now tell your friend to join you:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre>ssh pairprogger@your-public-ip
wemux attach
</pre></div>
</td></tr></table>

<h2>Bonus: Your first tmux config</h2>
<p>If you used GNU screen and if you are a Vim user, you will most likely find the 
settings in my <a href="https://github.com/mbrochh/mbrochh-dotfiles/blob/master/.tmux.conf">.tmux.conf</a>
very useful.</p>
<p>I hope I didn't forget anything. If so, please let me know in the comments!</p>
<p>Oh and: This is how it is going to look like:
<img alt="wemux server" src="http://martinbrochhaus.com/static/images/wemux.png" /></p>
<p>Note how wemux determines that my Ubuntu machine has lesser screen resolution
and automatically scales down the working area on my MacBook. If this is not
awesome...</p>
        </div>
    </div>
</div>

<div class="container">
    <div class="row comments">
        <div class="span3">&nbsp;</div>
        <div class="span6">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'martinbrochhauscom'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
</div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="span6">
                    <p><strong>Martin Brochhaus</strong> is the founder of <a href="http://bitmazk.com">Bitmazk Pte. Ltd.</a>. He is doing web development since 1998 and currently he is in love with Python & Django. Almost all of his work can be found on <a href="https://github.com/bitmazk">Github</a>. When he is not writing code, he gives <a href="https://speakerdeck.com/mbrochh">talks</a> or helps organizing <a href="https://pycon.sg">conferences</a>.</p>
                </div>
                <div class="span4">
                                            <p><strong>Say hi!</strong></p>
                        <ul class="socialLinks">
                                                            <li><a href="https://github.com/mbrochh"><span class="symbol">&#xe037;</span> Github</a></li>
                                                            <li><a href="https://plus.google.com/101162916953876296847/about"><span class="symbol">&#xe039;</span> Google Plus</a></li>
                                                            <li><a href="https://twitter.com/mbrochh"><span class="symbol">&#xe086;</span> Twitter</a></li>
                                                            <li><a href="https://facebook.com/mbrochh"><span class="symbol">&#xe027;</span> Facebook</a></li>
                                                            <li><a href="https://foursquare.com/mbrochh"><span class="symbol">&#xe032;</span> Foursquare</a></li>
                                                            <li><a href="http://www.linkedin.com/in/mbrochh"><span class="symbol">&#xe052;</span> LinkedIN</a></li>
                                                            <li><a href="https://secure.flickr.com/photos/mbrochh/"><span class="symbol">&#xe029;</span> Flickr</a></li>
                                                    </ul>
                                    </div>
            </div>
        </div>
    </div>

    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="http://martinbrochhaus.com/theme/js/bootstrap.min.js"></script>
        <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1147761-33']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>